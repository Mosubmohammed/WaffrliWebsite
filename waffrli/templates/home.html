{% extends "base.html" %} {% load static %} {% block content %}
<link href="{% static 'css/wishlist.css' %}" rel="stylesheet" />
<div class="product-container">
  {% for product in products %}
  <a href="{% url 'deal_or_product_detail' product.id %}" class="product-card">
    {% if product.customer_pic_id and product.customer_pic_id.image %}
    <img
      src="{{ product.customer_pic_id.image.url }}"
      alt="User Icon"
      class="rounded-circle me-2"
      width="30"
      height="30"
    />
    {% else %}
    <img
      src="{% static 'images/default-profile.png' %}"
      alt="Default User"
      class="rounded-circle me-2"
      width="30"
      height="30"
    />
    {% endif %}
    <small class="text-muted">
      @{{ product.user.username }} {{ product.create_at|date:"d-m" }}
    </small>

    <div class="sale-tag">-40%</div>
    <img src="{{ product.image.url }}" alt="Product" />
    <div class="product-info">
      <h3>{{ product.Name }}</h3>
      <p class="description">{{ product.Description }}</p>
      <div class="price-container">
        <span class="current-price">${{ product.sale_price }}</span>
        <span class="original-price">${{ product.Price }}</span>
      </div>

    </div>
    {{product.store}}
    <div class="card-footer">
      <button class="like-btn" data-product-id="{{ product.id }}">
        <i
          class="{% if user in product.likes.all %}fas fa-heart{% else %}far fa-heart{% endif %}"
        ></i>
        <span class="like-count">{{ product.likes.count }}</span>
      </button>
      <button class="comment-btn"><i class="far fa-comment"></i></button>
    </div>
  </a>
  {% endfor %}
</div>

<script>
  document.querySelectorAll(".like-btn").forEach((button) => {
    button.addEventListener("click", function (event) {
      event.stopPropagation(); // Prevent clicking the card when liking
      event.preventDefault(); // Prevent the link from being followed
  
      let productId = this.getAttribute("data-product-id");
      let likeIcon = this.querySelector("i");
      let likeCount = this.querySelector(".like-count");
  
      fetch(`/like/${productId}/`, {
        method: "POST",
        headers: {
          "X-CSRFToken": "{{ csrf_token }}",
        },
      })
        .then((response) => {
          if (response.status === 401) {
            window.location.href = "{% url 'login' %}"; // Redirect to login if not authenticated
            return;
          }
          return response.json();
        })
        .then((data) => {
          if (data) {
            if (data.liked) {
              likeIcon.classList.remove("far");
              likeIcon.classList.add("fas");
            } else {
              likeIcon.classList.remove("fas");
              likeIcon.classList.add("far");
            }
            likeCount.innerText = data.like_count;
          }
        });
    });
  });
  
</script>

{% endblock %}
