{% extends "base.html" %}   
{% load static %} 
{% block content %}
<link href="{% static 'css/Sub-categories.css' %}" rel="stylesheet" />
<div class="container">
    {% comment %} <header>
        <h1>Electronics Deals</h1>
        <div class="categories">
            <div class="category-item">
                <img src="{% get_media_prefix %}uploads/product/laptop-svgrepo-com.svg" alt="Laptop">
                <span>Laptops</span>
            </div>
            <div class="category-item">
                <img src="{% get_media_prefix %}uploads/product/tablet-android-svgrepo-com.svg" alt="Laptop">
                <span>Tablets</span>
            </div>
            <div class="category-item">
                <img src="{% get_media_prefix %}uploads/product/printer-svgrepo-com.svg" alt="Laptop">
                <span>Prienters</span>
            </div>
            <div class="category-item">
                <img src="{% get_media_prefix %}uploads/product/iphone-style-smartphone-svgrepo-com.svg" alt="Laptop">
                <span>Phones</span>
            </div>
            <div class="category-item">
                <img src="{% get_media_prefix %}uploads/product/headphones-round-sound-svgrepo-com.svg" alt="Laptop">
                <span>Computers <br>
                    Accessories</span>
            </div>
        </div>
    </header> {% endcomment %}

    <div class="main-content">
        <aside class="filters">
            <h2>Filters</h2>


            <div class="filter-section">
                <h3>Stores</h3>
                {% for store in stores %}
                    <label>
                        <input type="checkbox" name="store" value="{{ store }}"> {{ store }}
                    </label>
                {% endfor %}
            </div>

            <div class="filter-section">
                <h3>Rating</h3>
                <label><input type="checkbox" name="rating" value="5"> Popular Deals</label>
                <label><input type="checkbox" name="rating" value="5"> 5★</label>
                <label><input type="checkbox" name="rating" value="4"> 4★</label>
                <label><input type="checkbox" name="rating" value="3"> 3★</label>
                <label><input type="checkbox" name="rating" value="2"> 2★</label>
                <label><input type="checkbox" name="rating" value="1"> 1★</label>

            </div>

            <div class="filter-section">
                <h3>Price Range</h3>
                <div class="price-slider">
                    <input type="range" id="priceRange" min="0" max="200" value="100">
                    <div class="price-inputs">
                        <input type="number" id="minPrice" value="0">
                        <span>to</span>
                        <input type="number" id="maxPrice" value="100">
                    </div>
                </div>
            </div>
            


            <div class="filter-section">
                <div class="filter-header toggle-brands">
                    <span>
                        <h3>Brands</h3>
                    </span>
                    <i class="fa-solid fa-chevron-down brand-toggle-icon"></i>
                </div>
                <div class="brand-list">
                    <label><input type="checkbox"> Logitech</label>
                    <label><input type="checkbox"> ASUS</label>
                    <label><input type="checkbox"> Anker</label>
                    <label><input type="checkbox"> Corsair</label>
                    <label><input type="checkbox"> UGREEN</label>
                    <label><input type="checkbox"> SanDisk</label>
                    <label><input type="checkbox"> Acer</label>
                    <label><input type="checkbox"> AKG</label>
                    <label><input type="checkbox"> Crucial</label>
                    <label><input type="checkbox"> JVC</label>
                </div>



                
        </aside>

        <main class="products">
            <div class="sort-bar">
                <select id="sortBy">
                    <option value="popular">Most Popular</option>
                    <option value="price-low">Price: Low to High</option>
                    <option value="price-high">Price: High to Low</option>
                    <option value="rating">Highest Rated</option>
                </select>
            </div>

            <div class="product-grid" id="productGrid">

            </div>

                <div id="product-list">
                {% for product in products %}
                    <div class="product-card">
                        <div class="card-header">
                            <div class="user-info">
                                {% if product.customer_pic_id and product.customer_pic_id.image %}
                                <img style="width: 20px; height: 24px" 
                                     src="{{ product.customer_pic_id.image.url }}" 
                                     alt="User Icon" 
                                     class="profile-pic" 
                                     width="30" 
                                     height="30" />
                                {% else %}
                                <img style="width: 20px; height: 24px" 
                                     src="{% static 'images/default-profile.png' %}" 
                                     alt="Default User" 
                                     class="profile-pic" 
                                     width="30" 
                                     height="30" />
                                {% endif %}
                                <div class="user-details">
                                    <span class="username">Found by <strong>@{{ product.user.username }}</strong></span>
                                    <span class="deal-time">{{ product.create_at|date:"d-m" }}</span>
                                </div>
                            </div>
                            <div class="sale-tag">-70%</div>
                        </div>
            
                        <img src="{{ product.image.url }}" alt="Product" />
            
                        <div class="product-info">
                            <h3>{{ product.Name }}</h3>
                            <p class="description">{{ product.Description }}</p>
            
                            <div class="price-container">
                                <span class="current-price">${{ product.sale_price }}</span>
                                <span class="original-price">${{ product.Price }}</span>
                            </div>
            
                            <div class="rating">
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star-half-alt"></i>
                                <span>(128)</span>
                            </div>
                        </div>
            
                        <div class="card-footer">
                            <button class="like-btn" data-product-id="{{ product.id }}">
                                <i class="{% if user in product.likes.all %}fas fa-heart{% else %}far fa-heart{% endif %}"></i>
                                <span class="like-count">{{ product.likes.count }}</span>
                            </button>
                            <button class="comment-btn">
                                <i class="far fa-comment"></i> {{ c }}
                            </button>
                        </div>
                    </div>
                {% endfor %}
            </div>
            

        
        </main>
    </div>
</div>




<script>

    // slider of the price 
    const priceRange = document.getElementById("priceRange");
    const minPrice = document.getElementById("minPrice");
    const maxPrice = document.getElementById("maxPrice");

    priceRange.addEventListener("input", function () {
        minPrice.value = this.min;
        maxPrice.value = this.value;
    });

    minPrice.addEventListener("input", function () {
        if (parseInt(minPrice.value) >= parseInt(maxPrice.value)) {
            minPrice.value = maxPrice.value - 1;
        }
    });

    maxPrice.addEventListener("input", function () {
        if (parseInt(maxPrice.value) <= parseInt(minPrice.value)) {
            maxPrice.value = parseInt(minPrice.value) + 1;
        }
        priceRange.value = maxPrice.value;
    });


    // brands filter
    document.addEventListener("DOMContentLoaded", function () {
        const brandHeader = document.querySelector(".toggle-brands");
        const brandList = document.querySelector(".brand-list");
        const icon = document.querySelector(".brand-toggle-icon");

        brandHeader.addEventListener("click", function () {

            if (brandList.style.display === "none" || brandList.style.display === "") {
                brandList.style.display = "block";
                icon.classList.add("rotate");
            } else {
                brandList.style.display = "none";
                icon.classList.remove("rotate");
            }
        });
    });

    document.addEventListener("DOMContentLoaded", function () {
        const checkboxes = document.querySelectorAll('input[name="store"]');
        const ratingCheckboxes = document.querySelectorAll('input[name="rating"]');
        const minPriceInput = document.getElementById("minPrice");
        const maxPriceInput = document.getElementById("maxPrice");
        const priceSlider = document.getElementById("priceRange");
    
        function fetchFilteredProducts() {
            let selectedStores = [];
            let selectedRatings = [];
    
            checkboxes.forEach(cb => {
                if (cb.checked) selectedStores.push(cb.value);
            });
    
            ratingCheckboxes.forEach(rb => {
                if (rb.checked) selectedRatings.push(rb.value);
            });
    
            let minPrice = minPriceInput.value || 0;
            let maxPrice = maxPriceInput.value || 999999;
    
            minPrice = parseFloat(minPrice);
            maxPrice = parseFloat(maxPrice);
    
            // Get current category from the URL
            const categorySlug = "{{ category.name|slugify }}";
    
            // Send AJAX request with store, price, and rating filters
            fetch(`/category/${categorySlug}/filter-products/?stores=${selectedStores.join(",")}&min_price=${minPrice}&max_price=${maxPrice}&ratings=${selectedRatings.join(",")}`)
                .then(response => response.json())
                .then(data => {
                    const productList = document.getElementById("product-list");
                    productList.innerHTML = ""; // Clear existing products
    
                    if (data.products.length === 0) {
                        productList.innerHTML = "<p>No products found.</p>";
                        return;
                    }
    
                    data.products.forEach(product => {
                        const productCard = document.createElement("div");
                        productCard.classList.add("product-card");
                        productCard.innerHTML = `
                            <div class="card-header">
                                <div class="user-info">
                                    <img style="width: 20px; height: 24px" 
                                        src="${product.customer_pic_url || '/static/images/default-profile.png'}" 
                                        alt="User Icon" 
                                        class="profile-pic"
                                        width="30" 
                                        height="30" />
                                    <div class="user-details">
                                        <span class="username">Found by <strong>@${product.username}</strong></span>
                                        <span class="deal-time">${product.create_at}</span>
                                    </div>
                                </div>
                            </div>
    
                            <img src="${product.image_url}" alt="Product" />
    
                            <div class="product-info">
                                <h3>${product.name}</h3>
                                <p class="description">${product.description}</p>
                                <div class="price-container">
                                    <span class="current-price">$${product.sale_price}</span>
                                    <span class="original-price">$${product.price}</span>
                                </div>
                                <div class="likes">👍 ${product.likes_count} Likes</div>
                            </div>
    
                            <div class="card-footer">
                                <button class="like-btn" data-product-id="${product.id}">
                                    <i class="${product.liked_by_user ? 'fas fa-heart' : 'far fa-heart'}"></i>
                                    <span class="like-count">${product.likes_count}</span>
                                </button>
                            </div>
                        `;
                        productList.appendChild(productCard);
                    });
                })
                .catch(error => console.error("Error fetching products:", error));
        }
    
        // Event Listeners
        checkboxes.forEach(checkbox => checkbox.addEventListener("change", fetchFilteredProducts));
        ratingCheckboxes.forEach(checkbox => checkbox.addEventListener("change", fetchFilteredProducts));
        minPriceInput.addEventListener("input", fetchFilteredProducts);
        maxPriceInput.addEventListener("input", fetchFilteredProducts);
        priceSlider.addEventListener("input", function () {
            maxPriceInput.value = priceSlider.value;
            fetchFilteredProducts();
        });
    });
    
    
</script>
{%endblock%}